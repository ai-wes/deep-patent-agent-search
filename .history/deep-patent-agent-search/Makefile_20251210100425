install:
	@command -v uv >/dev/null 2>&1 || { echo "uv is not installed. Installing uv..."; curl -LsSf https://astral.sh/uv/0.6.12/install.sh | sh; source $HOME/.local/bin/env; }
	uv sync && npm --prefix frontend install

dev:
	make dev-backend & make dev-frontend

dev-backend:
	uv run adk api_server app --allow_origins="*"

dev-frontend:
	npm --prefix frontend run dev

playground:
	uv run adk web --port 8501

# -------- Phase router (maps legacy P-codes to ADK agents) --------
# Usage:
#   make phase PHASE=P7b PROJECT_ID=myproj STATE_DIR=projects/myproj/05_artifacts
# Defaults: STATE_DIR auto-resolves to projects/<project>/05_artifacts when present.
PHASE ?= P7a
PROJECT_ID ?= demo
STATE_DIR ?=
ALLOW_ORIGINS ?=*
phase:
	uv run python scripts/phase_router.py --phase $(PHASE) --project-id $(PROJECT_ID) $(if $(STATE_DIR),--state-dir $(STATE_DIR),) --allow-origins $(ALLOW_ORIGINS)

# -------- End-to-end legacy pipeline + ADK agents --------
PROJECT_ID ?= demo

run-all-phases:
	@echo "→ Running all phases for $(PROJECT_ID)..."
	@echo ""
	@echo "Phase P1..."
	PYTHONPATH="src" python -m scripts.streamlit.refactored_app_3 --project-id $(PROJECT_ID) --phase P1
	@echo ""
	@echo "Phase P2..."
	PYTHONPATH="src" python -m scripts.streamlit.refactored_app_3 --project-id $(PROJECT_ID) --phase P2
	@echo ""
	@echo "Phase P2a..."
	PYTHONPATH="src" python -m scripts.streamlit.refactored_app_3 --project-id $(PROJECT_ID) --phase P2a
	@echo ""
	@echo "Phase P3..."
	PYTHONPATH="src" python -m scripts.streamlit.refactored_app_3 --project-id $(PROJECT_ID) --phase P3
	@echo ""
	@echo "Phase P4..."
	PYTHONPATH="src" python -m scripts.streamlit.refactored_app_3 --project-id $(PROJECT_ID) --phase P4
	@echo ""
	@echo "Injecting single target (if provided)..."
	python -m src.app.pipeline.inject_single_target_into_portfolio_v4 --project-id $(PROJECT_ID) --single-target single_target.json || true
	@echo ""
	@echo "Phase P5..."
	PYTHONPATH="src" python -m scripts.streamlit.refactored_app_3 --project-id $(PROJECT_ID) --phase P5
	@echo ""
	@echo "Phase P6..."
	PYTHONPATH="src" python -m scripts.streamlit.refactored_app_3 --project-id $(PROJECT_ID) --phase P6
	@echo ""
	@echo "ADK agents (prior_art, risk, regulatory_cmc, commercial, mechanistic, safety, unmet_need)..."
	uv run python scripts/phase_router.py --phase P7a --project-id $(PROJECT_ID)
	uv run python scripts/phase_router.py --phase P7b --project-id $(PROJECT_ID)
	uv run python scripts/phase_router.py --phase P7c --project-id $(PROJECT_ID)
	uv run python scripts/phase_router.py --phase P7d --project-id $(PROJECT_ID)
	uv run python scripts/phase_router.py --phase P7e --project-id $(PROJECT_ID)
	uv run python scripts/phase_router.py --phase safety --project-id $(PROJECT_ID)
	uv run python scripts/phase_router.py --phase unmet --project-id $(PROJECT_ID)
	@echo ""
	@echo "Phase P7d..."
	PYTHONPATH="src" python -m scripts.streamlit.refactored_app_3 --project-id $(PROJECT_ID) --phase P7d
	@echo ""
	@echo "Phase P7e..."
	PYTHONPATH="src" python -m scripts.streamlit.refactored_app_3 --project-id $(PROJECT_ID) --phase P7e
	@echo ""
	@echo "Phase P8a..."
	PYTHONPATH="src" python -m scripts.streamlit.refactored_app_3 --project-id $(PROJECT_ID) --phase P8a
	@echo ""
	@echo "Phase P8b..."
	PYTHONPATH="src" python -m scripts.streamlit.refactored_app_3 --project-id $(PROJECT_ID) --phase P8b
	@echo ""
	@echo "Phase P9..."
	PYTHONPATH="src" python -m scripts.streamlit.refactored_app_3 --project-id $(PROJECT_ID) --phase P9
	@echo ""
	@echo "Phase P12..."
	PYTHONPATH="src" python -m scripts.streamlit.refactored_app_3 --project-id $(PROJECT_ID) --phase P12
	@echo ""
	@echo "Phase P11..."
	PYTHONPATH="src" python -m scripts.streamlit.refactored_app_3 --project-id $(PROJECT_ID) --phase P11
	@echo ""
	@echo "Phase P14..."
	PYTHONPATH="src" python -m scripts.streamlit.refactored_app_3 --project-id $(PROJECT_ID) --phase P14
	@echo ""
	@echo "✔ All phases completed for $(PROJECT_ID)"

lint:
	uv sync --dev --extra lint
	uv run codespell
	uv run ruff check . --diff
	uv run ruff format . --check --diff
	uv run mypy .

# --- Commands from Agent Starter Pack ---

backend: deploy


deploy:
	# Export dependencies to requirements file using uv export.
	(uv export --no-hashes --no-header --no-dev --no-emit-project --no-annotate > app/app_utils/.requirements.txt 2>/dev/null || \
	uv export --no-hashes --no-header --no-dev --no-emit-project > app/app_utils/.requirements.txt) && \
	uv run -m app.app_utils.deploy \
		--source-packages=./app \
		--entrypoint-module=app.agent_engine_app \
		--entrypoint-object=agent_engine \
		--requirements-file=app/app_utils/.requirements.txt

register-gemini-enterprise:
	@uvx agent-starter-pack@0.21.0 register-gemini-enterprise

setup-dev-env:
	PROJECT_ID=$$(gcloud config get-value project) && \
	(cd deployment/terraform/dev && terraform init && terraform apply --var-file vars/env.tfvars --var dev_project_id=$$PROJECT_ID --auto-approve)

test:
	uv sync --dev
	uv run pytest tests/unit && uv run pytest tests/integration

